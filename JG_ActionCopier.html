<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Joystick Gremlin Profile Paster v2.1</title>
    <style>
    body { font-family: "Segoe UI", sans-serif; margin: 2em; background-color: #f0f0f0; }
    h1, h2, h3 { font-family: "Segoe UI Light", sans-serif; }
    .wizard-step { display: none; border: 1px solid #ccc; padding: 1.5em; background-color: #fff; margin-top: 1em; }
    #step1 { display: block; }
    .container { display: flex; gap: 2em; }
    .panel { flex: 1; border: 1px solid #ddd; padding: 1em; height: 60vh; overflow-y: auto; }
    #sourceTree, #targetTree { list-style-type: none; padding-left: 0; }
    #sourceTree ul, #targetTree ul { list-style-type: none; padding-left: 20px; }
    #sourceTree li, #targetTree li { padding: 4px; }
    .selectable { cursor: pointer; }
    .selectable:hover { background-color: #e0e0e0; }
    .selected { background-color: #0078d4; color: white; }
    .parent-item { font-weight: bold; cursor: default; }
    .add-new-item { color: #006400; font-weight: bold; }
    .file-input-label { display: block; margin-bottom: 1em; }
    input[type="text"], input[type="file"] { width: 100%; padding: 8px; box-sizing: border-box; margin-bottom: 1em; }
    button { font-size: 1em; padding: 10px 15px; cursor: pointer; margin-right: 10px; background-color: #ddd; border: 1px solid #bbb; }
    button:hover { background-color: #ccc; }
    button:disabled { cursor: not-allowed; background-color: #eee; color: #aaa; }
    #actionsPanel, #logPanel { margin-top: 1em; padding: 1em; border: 1px solid #ccc; background-color: #f9f9f9; }
    .emoji-icon { font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji"; display: inline-block; width: 28px; text-align: center; }
    .description { color: #555; font-style: italic; }
    .selected .description { color: #eee; }
    #operationsLog { list-style-type: none; padding-left: 0; max-height: 150px; overflow-y: auto; background-color: #fff; border: 1px solid #ddd; padding: 10px; }
    .log-time { font-weight: bold; color: #005a9e; }
    .log-action-add { color: green; }
    .log-action-replace { color: orange; }
    #previewModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; }
    .modal-content { position: relative; background-color: #fff; margin: 5% auto; padding: 20px; width: 90%; max-width: 1800px; max-height: 80vh; overflow-y: auto; }
    .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; cursor: pointer; }
    .preview-container { display: flex; gap: 20px; margin-top: 20px; }
    .preview-panel { flex: 1; border: 1px solid #ddd; padding: 15px; background-color: #f9f9f9; }
    .preview-panel pre { white-space: pre-wrap; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; padding: 10px; background-color: #f0f0f0; border: 1px solid #ddd; }
    .preview-summary { text-align: center; font-size: 1.2em; margin: 15px 0; padding: 10px; border: 1px solid; }
    .summary-add { background-color: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
    .summary-replace { background-color: #fff3e0; color: #ef6c00; border-color: #ffcc80; }
    .preview-buttons { margin-top: 20px; text-align: center; }
    </style>
</head>
<body>

    <h1><span class="emoji-icon">üõ†Ô∏è</span> Joystick Gremlin Profile Paster v2.1 (Perfected)</h1>
    <p>A self-contained tool to copy actions between profiles with granular add/replace control.</p>

    <div id="step1" class="wizard-step">
        <h2><span class="emoji-icon">üìÇ</span> Step 1: Load Profiles</h2>
        <input type="file" id="sourceFiles" multiple accept=".xml">
        <input type="file" id="targetFile" accept=".xml">
        <button id="loadFilesBtn"><span class="emoji-icon">‚ö°</span> Process Files</button>
    </div>

    <div id="step2" class="wizard-step">
        <h2><span class="emoji-icon">üå≥</span> Step 2: Copy & Paste Actions</h2>
        <div class="container">
            <div class="panel">
                <h3><span class="emoji-icon">üîç</span> Source Library</h3>
                <input type="text" id="searchSource" placeholder="Search profiles, devices, inputs...">
                <ul id="sourceTree"></ul>
            </div>
            <div class="panel">
                <h3><span class="emoji-icon">üéØ</span> Target Destinations</h3>
                <p id="targetInstruction">Select a source container to see destinations.</p>
                <ul id="targetTree"></ul>
            </div>
        </div>
        <div id="actionsPanel">
            <h3><span class="emoji-icon">‚úÖ</span> Step 3: Confirm & Save</h3>
            <p><strong>Selected Source:</strong> <span id="selectedSourceInfo">None</span></p>
            <p><strong>Selected Target:</strong> <span id="selectedTargetInfo">None</span></p>
            <button id="confirmCopyBtn" disabled>Preview Operation</button>
            <hr>
            <input type="text" id="outputFileName" disabled>
            <button id="saveBtn" disabled>Save Modified Profile</button>
            <button id="startOverBtn">Start Over</button>
        </div>
        <div id="logPanel">
            <h3><span class="emoji-icon">üìã</span> Operation Log</h3>
            <ul id="operationsLog"><li>No operations performed yet.</li></ul>
        </div>
    </div>
    
    <div id="previewModal">
        <div class="modal-content">
            <span class="close-modal">√ó</span>
            <h3><span class="emoji-icon">üëÅÔ∏è</span> Preview Operation</h3>
            <p id="previewSummary" class="preview-summary"></p>
            <div class="preview-container">
                <div class="preview-panel">
                    <h4>Source Content</h4>
                    <pre id="previewSourceXml"></pre>
                </div>
                <div class="preview-panel">
                    <h4 id="previewTargetHeader"></h4>
                    <pre id="previewTargetXml"></pre>
                </div>
            </div>
            <div class="preview-buttons">
                <button id="previewConfirmBtn">Confirm</button>
                <button id="previewCancelBtn">Cancel</button>
            </div>
        </div>
    </div>

<script>
// --- JAVASCRIPT APPLICATION LOGIC (v2.1 - Perfected) ---
const get = (id) => document.getElementById(id);
const step1 = get('step1'), step2 = get('step2');
const loadFilesBtn = get('loadFilesBtn'), sourceFilesInput = get('sourceFiles'), targetFileInput = get('targetFile');
const sourceTree = get('sourceTree'), targetTree = get('targetTree');
const searchSource = get('searchSource'), targetInstruction = get('targetInstruction');
const selectedSourceInfo = get('selectedSourceInfo'), selectedTargetInfo = get('selectedTargetInfo');
const confirmCopyBtn = get('confirmCopyBtn'), saveBtn = get('saveBtn'), startOverBtn = get('startOverBtn');
const outputFileName = get('outputFileName');
const operationsLog = get('operationsLog');
const previewModal = get('previewModal'), closeModal = document.querySelector('.close-modal');
const previewSummary = get('previewSummary'), previewSourceXml = get('previewSourceXml'), previewTargetXml = get('previewTargetXml');
const previewConfirmBtn = get('previewConfirmBtn'), previewCancelBtn = get('previewCancelBtn');
const previewTargetHeader = get('previewTargetHeader');

let sourceDOMs = {}, targetDOM = null, targetFileName = '';
let selectedSourceData = null, selectedTargetData = null;
let hasUnsavedChanges = false;
let logIsEmpty = true;
let pendingSourceContainer = null, pendingTargetParent = null;

function generateContainerDescription(container) {
    const actionSet = container.querySelector('action-set');
    if (!actionSet) return "Container (No Action Set)";
    const actions = Array.from(actionSet.children);
    if (actions.length === 0) return "Container (Empty)";
    return `Container: ${actions.map(a => a.tagName).join(', ')}`;
}

function createListItem(options) {
    const li = document.createElement('li');
    li.innerHTML = `<span class="emoji-icon">${options.icon}</span><span class="${options.className || ''}">${options.text}</span>`;
    if (options.isSelectable) {
        li.classList.add('selectable');
        li.dataset.tree = options.treeType;
        li.dataset.info = JSON.stringify(options.data);
    }
    if (options.extraClass) li.classList.add(options.extraClass);
    return li;
}

loadFilesBtn.addEventListener('click', () => {
    // File loading logic is robust and remains unchanged.
    const sourceFiles = sourceFilesInput.files;
    const targetFile = targetFileInput.files[0];
    if (sourceFiles.length === 0 || !targetFile) { alert('Please select both source and target files.'); return; }
    sourceDOMs = {};
    let filesToProcess = sourceFiles.length + 1;
    const onFileProcessed = () => {
        if (--filesToProcess === 0) {
            buildSourceTreeView();
            step1.style.display = 'none';
            step2.style.display = 'block';
        }
    };
    Array.from(sourceFiles).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const xmlDoc = new DOMParser().parseFromString(e.target.result, "application/xml");
                if (xmlDoc.querySelector("parsererror")) throw new Error(`Parser error in ${file.name}`);
                sourceDOMs[file.name] = xmlDoc;
                onFileProcessed();
            } catch (error) { alert(`Error: ${error.message}`); }
        };
        reader.readAsText(file);
    });
    const targetReader = new FileReader();
    targetReader.onload = (e) => {
        try {
            const xmlDoc = new DOMParser().parseFromString(e.target.result, "application/xml");
            if (xmlDoc.querySelector("parsererror")) throw new Error(`Parser error in ${targetFile.name}`);
            targetDOM = xmlDoc;
            targetFileName = targetFile.name;
            outputFileName.value = targetFileName;
            onFileProcessed();
        } catch (error) { alert(`Error: ${error.message}`); }
    };
    targetReader.readAsText(targetFile);
});

function buildSourceTreeView() {
    sourceTree.innerHTML = '';
    Object.keys(sourceDOMs).sort().forEach(filename => {
        const profileNode = createListItem({ icon: 'üìÑ', text: filename, className: 'parent-item' });
        const deviceList = document.createElement('ul');
        sourceDOMs[filename].querySelectorAll('device').forEach(device => {
            const deviceName = device.getAttribute('name');
            const deviceGuid = device.getAttribute('device-guid');
            if (!deviceName || !deviceGuid) return;

            const deviceNode = createListItem({ icon: 'üéÆ', text: deviceName, className: 'parent-item' });
            const itemList = document.createElement('ul');
            device.querySelectorAll('mode > axis, mode > button').forEach(element => {
                const containers = element.querySelectorAll(':scope > container');
                if (containers.length === 0) return;
                
                const type = element.tagName;
                const id = element.getAttribute('id');
                const parentText = `${type.charAt(0).toUpperCase() + type.slice(1)} ${id} <span class="description">(${containers.length})</span>`;
                const parentNode = createListItem({ icon: 'üéõÔ∏è', text: parentText, className: 'parent-item' });
                const containerList = document.createElement('ul');
                containers.forEach((container, index) => {
                    containerList.appendChild(createListItem({
                        icon: '‚Ü≥',
                        text: generateContainerDescription(container),
                        isSelectable: true, treeType: 'source',
                        data: { filename, deviceGuid, type, id, containerIndex: index }
                    }));
                });
                parentNode.appendChild(containerList);
                itemList.appendChild(parentNode);
            });
            if (itemList.hasChildNodes()) deviceNode.appendChild(itemList);
            if (deviceNode.querySelector('li')) deviceList.appendChild(deviceNode);
        });
        if (deviceList.hasChildNodes()) profileNode.appendChild(deviceList);
        if (profileNode.querySelector('li')) sourceTree.appendChild(profileNode);
    });
}

function buildTargetSelectionView(sourceData) {
    targetTree.innerHTML = '';
    targetInstruction.style.display = 'none';
    const targetType = sourceData.type;
    targetDOM.querySelectorAll('device').forEach(device => {
        const deviceName = device.getAttribute('name');
        const deviceGuid = device.getAttribute('device-guid');
        const deviceNode = createListItem({ icon: 'üéÆ', text: deviceName, className: 'parent-item' });
        const itemList = document.createElement('ul');
        device.querySelectorAll(`mode > ${targetType}`).forEach(element => {
            const id = element.getAttribute('id');
            const parentNode = createListItem({ icon: 'üéõÔ∏è', text: `${targetType.charAt(0).toUpperCase() + targetType.slice(1)} ${id}`, className: 'parent-item' });
            const containerList = document.createElement('ul');
            const baseData = { deviceGuid, type: targetType, id };
            containerList.appendChild(createListItem({
                icon: '‚ûï', text: '[Add as New Container]',
                isSelectable: true, treeType: 'target',
                data: { ...baseData, containerIndex: -1 },
                extraClass: 'add-new-item'
            }));
            element.querySelectorAll(':scope > container').forEach((container, index) => {
                containerList.appendChild(createListItem({
                    icon: '‚Ü≥', text: generateContainerDescription(container),
                    isSelectable: true, treeType: 'target',
                    data: { ...baseData, containerIndex: index }
                }));
            });
            parentNode.appendChild(containerList);
            itemList.appendChild(parentNode);
        });
        if (itemList.hasChildNodes()) deviceNode.appendChild(itemList);
        if (deviceNode.querySelector('li')) targetTree.appendChild(deviceNode);
    });
}

document.addEventListener('click', (e) => {
    const selectable = e.target.closest('.selectable');
    if (!selectable) return;
    const treeType = selectable.dataset.tree;
    document.querySelectorAll(`.${treeType}Tree .selected`).forEach(el => el.classList.remove('selected'));
    selectable.classList.add('selected');

    if (treeType === 'source') {
        selectedSourceData = JSON.parse(selectable.dataset.info);
        selectedTargetData = null; // Invalidate target on new source selection
        selectedSourceInfo.textContent = `Container ${selectedSourceData.containerIndex + 1} from ${selectedSourceData.type} ${selectedSourceData.id}`;
        selectedTargetInfo.textContent = 'None';
        confirmCopyBtn.disabled = true;
        buildTargetSelectionView(selectedSourceData);
    } else {
        selectedTargetData = JSON.parse(selectable.dataset.info);
        selectedTargetInfo.textContent = selectedTargetData.containerIndex === -1
            ? `Add to ${selectedTargetData.type} ${selectedTargetData.id}`
            : `Replace Container ${selectedTargetData.containerIndex + 1} on ${selectedTargetData.type} ${selectedTargetData.id}`;
        confirmCopyBtn.disabled = false;
    }
});

confirmCopyBtn.addEventListener('click', () => {
    // REFINEMENT: Use .textContent for safer and simpler XML display
    const serializer = new XMLSerializer();
    const sourceParent = sourceDOMs[selectedSourceData.filename].querySelector(`device[device-guid="${selectedSourceData.deviceGuid}"] > mode > ${selectedSourceData.type}[id="${selectedSourceData.id}"]`);
    pendingSourceContainer = sourceParent.querySelectorAll(':scope > container')[selectedSourceData.containerIndex];
    pendingTargetParent = targetDOM.querySelector(`device[device-guid="${selectedTargetData.deviceGuid}"] > mode > ${selectedTargetData.type}[id="${selectedTargetData.id}"]`);
    
    previewSourceXml.textContent = serializer.serializeToString(pendingSourceContainer);

    if (selectedTargetData.containerIndex === -1) { // ADD
        previewSummary.className = 'preview-summary summary-add';
        previewSummary.textContent = `You are about to ADD this container.`;
        previewTargetHeader.textContent = `Target Axis/Button (All existing containers)`;
        let allTargetXml = Array.from(pendingTargetParent.querySelectorAll(':scope > container'))
                                .map(c => serializer.serializeToString(c))
                                .join('\n\n');
        previewTargetXml.textContent = allTargetXml || 'Target is currently empty.';
    } else { // REPLACE
        const containerToReplace = pendingTargetParent.querySelectorAll(':scope > container')[selectedTargetData.containerIndex];
        previewSummary.className = 'preview-summary summary-replace';
        previewSummary.textContent = `You are about to REPLACE this target container.`;
        previewTargetHeader.textContent = `Target Container to be Replaced`;
        previewTargetXml.textContent = serializer.serializeToString(containerToReplace);
    }
    previewModal.style.display = 'block';
});

previewConfirmBtn.addEventListener('click', () => {
    const elementToInsert = pendingSourceContainer.cloneNode(true);
    const logAction = selectedTargetData.containerIndex === -1 ? 'ADD' : 'REPLACE';
    
    if (logAction === 'ADD') {
        pendingTargetParent.appendChild(elementToInsert);
    } else {
        const containerToReplace = pendingTargetParent.querySelectorAll(':scope > container')[selectedTargetData.containerIndex];
        pendingTargetParent.replaceChild(elementToInsert, containerToReplace);
    }

    addLogEntry(`[${logAction}] Container on ${selectedTargetData.type} ${selectedTargetData.id}.`);
    hasUnsavedChanges = true;
    saveBtn.disabled = false;
    outputFileName.disabled = false;
    
    // UX BUG FIX: Instead of a full reset, just refresh the target tree view
    const currentTargetSelection = selectedTargetData;
    buildTargetSelectionView(selectedSourceData);
    // Re-select the same target parent for a smooth workflow
    document.querySelectorAll('#targetTree .selectable').forEach(li => {
        const info = JSON.parse(li.dataset.info);
        if (info.deviceGuid === currentTargetSelection.deviceGuid && info.id === currentTargetSelection.id && info.containerIndex === currentTargetSelection.containerIndex) {
            li.classList.add('selected');
        }
    });
    
    previewModal.style.display = 'none';
});

// FUNCTIONAL BUG FIX: Corrected search algorithm
searchSource.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const allItems = Array.from(sourceTree.querySelectorAll('li'));
    if (!searchTerm) {
        allItems.forEach(li => li.style.display = '');
        return;
    }

    allItems.forEach(li => {
        li.style.display = 'none'; // Hide all by default
        li.dataset.keepVisible = 'false';
    });

    const leafItems = allItems.filter(li => li.classList.contains('selectable'));
    leafItems.forEach(li => {
        if (li.textContent.toLowerCase().includes(searchTerm)) {
            let current = li;
            while (current && current !== sourceTree) {
                current.dataset.keepVisible = 'true';
                current = current.parentElement.closest('li');
            }
        }
    });

    allItems.forEach(li => {
        if (li.dataset.keepVisible === 'true') {
            li.style.display = '';
        }
    });
});

function addLogEntry(message) {
    if (logIsEmpty) { operationsLog.innerHTML = ''; logIsEmpty = false; }
    const logItem = document.createElement('li');
    logItem.innerHTML = `<span class="log-time">[${new Date().toLocaleTimeString()}]</span> ${message}`;
    operationsLog.prepend(logItem);
}

saveBtn.addEventListener('click', () => {
    const finalFileName = outputFileName.value.trim();
    if (!finalFileName) { alert('Output filename cannot be empty.'); return; }
    const xmlString = '<?xml version="1.0" encoding="utf-8"?>\n' + new XMLSerializer().serializeToString(targetDOM.documentElement);
    const blob = new Blob([xmlString], { type: 'application/xml' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = finalFileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
});

startOverBtn.addEventListener('click', () => window.location.reload());
previewCancelBtn.addEventListener('click', () => previewModal.style.display = 'none');
closeModal.addEventListener('click', () => previewModal.style.display = 'none');
</script>

</body>
</html>
