<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Joystick Gremlin Profile Paster v1.07</title>
    <style>
        /* Spartan, functional styling as requested. */
        body { font-family: "Segoe UI", sans-serif; margin: 2em; background-color: #f0f0f0; }
        h1, h2, h3 { font-family: "Segoe UI Light", sans-serif; }
        .wizard-step { display: none; border: 1px solid #ccc; padding: 1.5em; background-color: #fff; margin-top: 1em; }
        #step1 { display: block; }
        .container { display: flex; gap: 2em; }
        .panel { flex: 1; border: 1px solid #ddd; padding: 1em; height: 60vh; overflow-y: auto; }
        #sourceTree, #targetTree { list-style-type: none; padding-left: 0; }
        #sourceTree ul, #targetTree ul { list-style-type: none; padding-left: 20px; }
        #sourceTree li, #targetTree li { padding: 4px; }
        .selectable { cursor: pointer; }
        .selectable:hover { background-color: #e0e0e0; }
        .selected { background-color: #0078d4; color: white; }
        .file-input-label { display: block; margin-bottom: 1em; }
        input[type="text"], input[type="file"] { width: 100%; padding: 8px; box-sizing: border-box; margin-bottom: 1em; }
        button { font-size: 1em; padding: 10px 15px; cursor: pointer; margin-right: 10px; background-color: #ddd; border: 1px solid #bbb; }
        button:hover { background-color: #ccc; }
        button:disabled { cursor: not-allowed; background-color: #eee; color: #aaa; }
        #actionsPanel, #logPanel { margin-top: 1em; padding: 1em; border: 1px solid #ccc; background-color: #f9f9f9; }
        .emoji-icon { font-family: "Segoe UI Emoji"; display: inline-block; width: 28px; text-align: center; }
        .description { color: #555; font-style: italic; }
        .selected .description { color: #eee; }
        #operationsLog { list-style-type: none; padding-left: 0; max-height: 150px; overflow-y: auto; background-color: #fff; border: 1px solid #ddd; padding: 10px; }
        #operationsLog li { padding: 5px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        #operationsLog li:last-child { border-bottom: none; }
        .log-time { font-weight: bold; color: #005a9e; }
    </style>
</head>
<body>

    <h1><span class="emoji-icon">üõ†Ô∏è</span> Joystick Gremlin Profile Paster v1.07</h1>
    <p>A self-contained tool to copy actions, curves, and macros between profiles.</p>

    <!-- STEP 1: FILE UPLOAD -->
    <div id="step1" class="wizard-step">
        <h2><span class="emoji-icon">üìÇ</span> Step 1: Load Your Profiles</h2>
        <p>Load one or more 'source' profiles to build the database of copyable items. Then, load the single 'target' profile you wish to modify.</p>
        
        <label for="sourceFiles" class="file-input-label"><strong>1. Select Source Profile(s) (.xml):</strong></label>
        <input type="file" id="sourceFiles" multiple accept=".xml">

        <label for="targetFile" class="file-input-label"><strong>2. Select Target Profile (.xml):</strong></label>
        <input type="file" id="targetFile" accept=".xml">

        <button id="loadFilesBtn"><span class="emoji-icon">‚ö°</span> Process Files</button>
        <p id="loadingStatus"></p>
    </div>

    <!-- STEP 2: MAIN APPLICATION INTERFACE -->
    <div id="step2" class="wizard-step">
        <h2><span class="emoji-icon">üå≥</span> Step 2: Copy & Paste Actions</h2>
        <div class="container">
            <div class="panel">
                <h3><span class="emoji-icon">üîç</span> Source Library</h3>
                <input type="text" id="searchSource" placeholder="Search profiles, devices, or descriptions...">
                <ul id="sourceTree"></ul>
            </div>
            <div class="panel">
                <h3><span class="emoji-icon">üéØ</span> Target Destinations</h3>
                <p id="targetInstruction">Select an item from the source library to see available destinations.</p>
                <ul id="targetTree"></ul>
            </div>
        </div>

        <div id="actionsPanel">
            <h3><span class="emoji-icon">‚úÖ</span> Step 3: Confirm & Save</h3>
            <p><strong>Selected Source:</strong> <span id="selectedSourceInfo">None</span></p>
            <p><strong>Selected Target:</strong> <span id="selectedTargetInfo">None</span></p>
            <button id="confirmCopyBtn" disabled><span class="emoji-icon">‚û°Ô∏è</span> Confirm Copy</button>
            <hr>
            <label for="outputFileName"><strong>Output Filename:</strong></label>
            <input type="text" id="outputFileName" disabled>
            <br><br>
            <button id="saveBtn" disabled><span class="emoji-icon">üíæ</span> Save Modified Profile</button>
            <button id="startOverBtn"><span class="emoji-icon">üîÑ</span> Start Over</button>
            <p id="saveStatus"></p>
        </div>

        <div id="logPanel">
            <h3><span class="emoji-icon">üìã</span> Record of Performed Operations</h3>
            <ul id="operationsLog">
                <li>No operations performed yet.</li>
            </ul>
        </div>
    </div>

<script>
// --- JAVASCRIPT APPLICATION LOGIC (v1.07) ---

// DOM Element References
const step1 = document.getElementById('step1'), step2 = document.getElementById('step2');
const loadFilesBtn = document.getElementById('loadFilesBtn'), sourceFilesInput = document.getElementById('sourceFiles'), targetFileInput = document.getElementById('targetFile');
const loadingStatus = document.getElementById('loadingStatus');
const sourceTree = document.getElementById('sourceTree'), targetTree = document.getElementById('targetTree');
const searchSource = document.getElementById('searchSource'), targetInstruction = document.getElementById('targetInstruction');
const selectedSourceInfo = document.getElementById('selectedSourceInfo'), selectedTargetInfo = document.getElementById('selectedTargetInfo');
const confirmCopyBtn = document.getElementById('confirmCopyBtn'), saveBtn = document.getElementById('saveBtn'), startOverBtn = document.getElementById('startOverBtn');
const outputFileName = document.getElementById('outputFileName');
const saveStatus = document.getElementById('saveStatus');
const operationsLog = document.getElementById('operationsLog');

// Application State
let sourceDOMs = {}, targetDOM = null, originalTargetContent = '', targetFileName = '';
let selectedSourceData = null, selectedTargetData = null;
let hasUnsavedChanges = false;
let logIsEmpty = true;

// --- UTILITY FUNCTIONS ---
function generateItemDescription(parentElement, isSource) {
    const childElement = parentElement.firstElementChild;
    if (!childElement) return "Empty";
    
    let parts = [`<strong>${childElement.tagName}</strong>`];
    const nameAttr = childElement.getAttribute('name');
    const parentDescAttr = parentElement.getAttribute('description');

    if (parentDescAttr) parts.push(`<span class="description">(Desc: "${parentDescAttr}")</span>`);
    if (nameAttr && isSource) parts.push(`<span class="description">(Name: "${nameAttr}")</span>`);
    
    if (childElement.tagName === 'container') {
        const actionSet = childElement.querySelector('action-set');
        if (actionSet) {
            const childActions = actionSet.querySelectorAll(':scope > *');
            if (childActions.length > 0) {
                const actionTypes = Array.from(childActions).map(n => n.tagName).slice(0, 3).join(', ');
                parts.push(`<span class="description">(${actionTypes}${childActions.length > 3 ? '...' : ''})</span>`);
            }
        }
    }
    return parts.join(' ');
}

// --- FILE HANDLING AND PARSING ---
loadFilesBtn.addEventListener('click', handleFileLoad);
startOverBtn.addEventListener('click', () => window.location.reload());

function handleFileLoad() {
    const sourceFiles = sourceFilesInput.files;
    const targetFile = targetFileInput.files[0];
    if (sourceFiles.length === 0 || !targetFile) {
        loadingStatus.textContent = '‚ö†Ô∏è Please select both source file(s) and a target file.';
        return;
    }
    loadingStatus.textContent = 'Processing...';
    sourceDOMs = {};
    let filesToProcess = sourceFiles.length + 1;
    const onFileProcessed = () => {
        if (--filesToProcess === 0) {
            buildSourceTreeView();
            step1.style.display = 'none';
            step2.style.display = 'block';
            loadingStatus.textContent = '';
        }
    };
    for (const file of sourceFiles) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(e.target.result, "application/xml");
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) throw new Error(`Parser error in ${file.name}`);
                sourceDOMs[file.name] = xmlDoc;
                onFileProcessed();
            } catch (error) { loadingStatus.textContent = `Error parsing ${file.name}: ${error.message}`; }
        };
        reader.readAsText(file);
    }
    const targetReader = new FileReader();
    targetReader.onload = (e) => {
        try {
            originalTargetContent = e.target.result;
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(e.target.result, "application/xml");
            if (xmlDoc.getElementsByTagName("parsererror").length > 0) throw new Error(`Parser error in ${targetFile.name}`);
            targetDOM = xmlDoc;
            targetFileName = targetFile.name;
            outputFileName.value = targetFileName;
            onFileProcessed();
        } catch (error) { loadingStatus.textContent = `Error parsing ${targetFile.name}: ${error.message}`; }
    };
    targetReader.readAsText(targetFile);
}

// --- UI BUILDING ---
function buildSourceTreeView() {
    sourceTree.innerHTML = '';
    const sortedFilenames = Object.keys(sourceDOMs).sort((a, b) => a.localeCompare(b));
    for (const filename of sortedFilenames) {
        const doc = sourceDOMs[filename];
        const profileNode = document.createElement('li');
        profileNode.innerHTML = `<span class="emoji-icon">üìÑ</span><strong>${filename}</strong>`;
        const deviceList = document.createElement('ul');
        const devices = Array.from(doc.querySelectorAll('device')).sort((a, b) => (a.getAttribute('name') || '').localeCompare(b.getAttribute('name') || ''));
        devices.forEach(device => {
            const deviceName = device.getAttribute('name');
            const deviceGuid = device.getAttribute('device-guid');
            if (!deviceGuid) return;

            const deviceNode = document.createElement('li');
            deviceNode.innerHTML = `<span class="emoji-icon">üéÆ</span>${deviceName}`;
            const itemList = document.createElement('ul');
            device.querySelectorAll('mode > axis, mode > button').forEach(element => {
                if (element.firstElementChild) {
                    const type = element.tagName;
                    const id = element.getAttribute('id');
                    const description = generateItemDescription(element, true);
                    const text = `${type.charAt(0).toUpperCase() + type.slice(1)} ${id}: ${description}`;
                    const data = { type, filename, deviceName, deviceGuid, id, elementType: element.firstElementChild.tagName };
                    itemList.appendChild(createSelectableListItem(text, data, 'source'));
                }
            });
            if (itemList.hasChildNodes()) {
                deviceNode.appendChild(itemList);
                deviceList.appendChild(deviceNode);
            }
        });
        if (deviceList.hasChildNodes()) {
            profileNode.appendChild(deviceList);
            sourceTree.appendChild(profileNode);
        }
    }
}

function createSelectableListItem(html, data, treeType) {
    const itemNode = document.createElement('li');
    itemNode.innerHTML = html;
    itemNode.classList.add('selectable');
    itemNode.dataset.tree = treeType;
    itemNode.dataset.info = JSON.stringify(data);
    return itemNode;
}

function buildTargetSelectionView(sourceData) {
    targetTree.innerHTML = '';
    targetInstruction.style.display = 'none';
    const devices = Array.from(targetDOM.querySelectorAll('device')).sort((a, b) => (a.getAttribute('name') || '').localeCompare(b.getAttribute('name') || ''));
    devices.forEach(device => {
        const deviceName = device.getAttribute('name');
        const deviceGuid = device.getAttribute('device-guid');
        if (!deviceGuid) return;

        const deviceNode = document.createElement('li');
        deviceNode.innerHTML = `<span class="emoji-icon">üéÆ</span><strong>${deviceName}</strong>`;
        const itemList = document.createElement('ul');
        const targetType = sourceData.type;
        device.querySelectorAll(`mode > ${targetType}`).forEach(element => {
            const id = element.getAttribute('id');
            const description = generateItemDescription(element, false);
            const text = `${targetType.charAt(0).toUpperCase() + targetType.slice(1)} ${id}: ${description}`;
            const data = { type: targetType, deviceName, deviceGuid, id };
            itemList.appendChild(createSelectableListItem(text, data, 'target'));
        });
        if (itemList.hasChildNodes()) {
            deviceNode.appendChild(itemList);
            targetTree.appendChild(deviceNode);
        }
    });
}

// --- INTERACTION LOGIC ---
document.addEventListener('click', (e) => {
    const selectable = e.target.closest('.selectable');
    if (!selectable) return;
    const treeType = selectable.dataset.tree;
    const data = JSON.parse(selectable.dataset.info);
    if (treeType === 'source') {
        document.querySelectorAll('#sourceTree .selected').forEach(el => el.classList.remove('selected'));
        selectable.classList.add('selected');
        resetTargetSelection();
        selectedSourceData = data;
        selectedSourceInfo.innerHTML = `<strong>${data.elementType}</strong> from <em>${data.filename}</em> &rarr; ${data.deviceName} &rarr; ${data.type} ${data.id}`;
        buildTargetSelectionView(data);
    } else if (treeType === 'target') {
        document.querySelectorAll('#targetTree .selected').forEach(el => el.classList.remove('selected'));
        selectable.classList.add('selected');
        selectedTargetData = data;
        selectedTargetInfo.innerHTML = `<em>${targetFileName}</em> &rarr; ${data.deviceName} &rarr; ${data.type} ${data.id}`;
        confirmCopyBtn.disabled = false;
    }
});

function resetSourceSelection() {
    document.querySelectorAll('#sourceTree .selected').forEach(el => el.classList.remove('selected'));
    selectedSourceData = null;
    selectedSourceInfo.textContent = 'None';
    targetTree.innerHTML = '';
    targetInstruction.style.display = 'block';
}

function resetTargetSelection() {
    document.querySelectorAll('#targetTree .selected').forEach(el => el.classList.remove('selected'));
    selectedTargetData = null;
    selectedTargetInfo.textContent = 'None';
    confirmCopyBtn.disabled = true;
}

confirmCopyBtn.addEventListener('click', () => {
    if (!selectedSourceData || !selectedTargetData) return;
    
    const sourceDoc = sourceDOMs[selectedSourceData.filename];
    const sourceParentQuery = `device[device-guid="${selectedSourceData.deviceGuid}"] > mode > ${selectedSourceData.type}[id="${selectedSourceData.id}"]`;
    const sourceParentElement = sourceDoc.querySelector(sourceParentQuery);
    const sourceChildElement = sourceParentElement ? sourceParentElement.firstElementChild : null;

    if (!sourceParentElement || !sourceChildElement) {
        alert(`Error: Could not find the source element to copy.`);
        return;
    }

    const targetParentQuery = `device[device-guid="${selectedTargetData.deviceGuid}"] > mode > ${selectedTargetData.type}[id="${selectedTargetData.id}"]`;
    const targetParentElement = targetDOM.querySelector(targetParentQuery);
    
    if (!targetParentElement) {
        alert(`Error: Could not find the target destination.`);
        return;
    }

    const sourceDescription = sourceParentElement.getAttribute('description');
    targetParentElement.setAttribute('description', sourceDescription || '');

    const elementToInsert = sourceChildElement.cloneNode(true);
    while (targetParentElement.firstChild) {
        targetParentElement.removeChild(targetParentElement.firstChild);
    }
    targetParentElement.appendChild(elementToInsert);

    addLogEntry(`Copied <strong>${elementToInsert.tagName}</strong> from <em>${selectedSourceData.deviceName} / ${selectedSourceData.type} ${selectedSourceData.id}</em> to <em>${selectedTargetData.deviceName} / ${selectedTargetData.type} ${selectedTargetData.id}</em>.`);
    
    hasUnsavedChanges = true;
    saveBtn.disabled = false;
    outputFileName.disabled = false;
    resetSourceSelection();
    resetTargetSelection();
});

function addLogEntry(message) {
    if (logIsEmpty) {
        operationsLog.innerHTML = '';
        logIsEmpty = false;
    }
    const logItem = document.createElement('li');
    const time = new Date().toLocaleTimeString();
    logItem.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
    operationsLog.prepend(logItem);
}

// --- SEARCH AND SAVE ---
searchSource.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const fileNodes = sourceTree.querySelectorAll(':scope > li');

    fileNodes.forEach(fileNode => {
        let fileVisible = false;
        const deviceNodes = fileNode.querySelectorAll(':scope > ul > li');
        
        deviceNodes.forEach(deviceNode => {
            let deviceVisible = false;
            const itemNodes = deviceNode.querySelectorAll(':scope > ul > li');

            itemNodes.forEach(itemNode => {
                const fullText = `${fileNode.firstChild.textContent} ${deviceNode.firstChild.textContent} ${itemNode.textContent}`.toLowerCase();
                if (fullText.includes(searchTerm)) {
                    itemNode.style.display = '';
                    deviceVisible = true;
                    fileVisible = true;
                } else {
                    itemNode.style.display = 'none';
                }
            });
            deviceNode.style.display = deviceVisible ? '' : 'none';
        });
        fileNode.style.display = fileVisible ? '' : 'none';
    });
});

saveBtn.addEventListener('click', () => {
    if (!targetDOM || !hasUnsavedChanges) return;
    const finalFileName = outputFileName.value.trim();
    if (!finalFileName) {
        alert('Output filename cannot be empty.');
        return;
    }
    const serializer = new XMLSerializer();
    const xmlString = '<?xml version="1.0" encoding="utf-8"?>\n' + serializer.serializeToString(targetDOM.documentElement);
    
    downloadFile(finalFileName, xmlString, 'application/xml');
    saveStatus.textContent = `üíæ Saved ${finalFileName}.`;
});

function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
}
</script>

</body>
</html>